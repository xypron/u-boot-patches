From 175a98cd7126e326ba15b326a658b20003072d41 Mon Sep 17 00:00:00 2001
From: Heinrich Schuchardt <xypron.glpk@gmx.de>
Date: Sun, 10 Nov 2019 02:28:46 +0100
Subject: [PATCH 1/1] efi_loader: call allow_unaligned() in efi_set_bootdev()

The device path functions handle unaligned packed structures and make u16
assignments.

Calling allow_unaligned() in path_to_uefi() is too late. Move the call to
efi_set_bootdev().

Signed-off-by: Heinrich Schuchardt <xypron.glpk@gmx.de>
---
 cmd/bootefi.c                    | 4 ++++
 lib/efi_loader/efi_device_path.c | 8 --------
 2 files changed, 4 insertions(+), 8 deletions(-)

diff --git a/cmd/bootefi.c b/cmd/bootefi.c
index f613cce7e2..e642a8b86b 100644
--- a/cmd/bootefi.c
+++ b/cmd/bootefi.c
@@ -18,6 +18,7 @@
 #include <mapmem.h>
 #include <memalign.h>
 #include <asm-generic/sections.h>
+#include <asm-generic/unaligned.h>
 #include <linux/linkage.h>
 
 DECLARE_GLOBAL_DATA_PTR;
@@ -628,6 +629,9 @@ void efi_set_bootdev(const char *dev, const char *devnr, const char *path)
 	struct efi_device_path *device, *image;
 	efi_status_t ret;
 
+	/* The device path functions deal with unaligned u16 assignements */
+	allow_unaligned();
+
 	/* efi_set_bootdev is typically called repeatedly, recover memory */
 	efi_free_pool(bootefi_device_path);
 	efi_free_pool(bootefi_image_path);
diff --git a/lib/efi_loader/efi_device_path.c b/lib/efi_loader/efi_device_path.c
index 70333eab8f..afef4e8450 100644
--- a/lib/efi_loader/efi_device_path.c
+++ b/lib/efi_loader/efi_device_path.c
@@ -13,7 +13,6 @@
 #include <efi_loader.h>
 #include <part.h>
 #include <sandboxblockdev.h>
-#include <asm-generic/unaligned.h>
 
 #ifdef CONFIG_SANDBOX
 const efi_guid_t efi_guid_host_dev = U_BOOT_HOST_DEV_GUID;
@@ -826,13 +825,6 @@ static void path_to_uefi(void *uefi, const char *src)
 {
 	u16 *pos = uefi;
 
-	/*
-	 * efi_set_bootdev() calls this routine indirectly before the UEFI
-	 * subsystem is initialized. So we cannot assume unaligned access to be
-	 * enabled.
-	 */
-	allow_unaligned();
-
 	while (*src) {
 		s32 code = utf8_get(&src);
 
-- 
2.24.0

