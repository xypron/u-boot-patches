From f9435cb16a30658dd16fba339de17eee95794847 Mon Sep 17 00:00:00 2001
From: Heinrich Schuchardt <xypron.glpk@gmx.de>
Date: Wed, 27 Jun 2018 20:08:57 +0200
Subject: [PATCH 1/1] efi_loader: correct headersize EFI tables

The headersize field has to be set to the size of the whole table
including the header.

Signed-off-by: Heinrich Schuchardt <xypron.glpk@gmx.de>
---
 lib/efi_loader/efi_boottime.c | 4 ++--
 lib/efi_loader/efi_runtime.c  | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/lib/efi_loader/efi_boottime.c b/lib/efi_loader/efi_boottime.c
index c804af181e..fe9a86b44b 100644
--- a/lib/efi_loader/efi_boottime.c
+++ b/lib/efi_loader/efi_boottime.c
@@ -2992,7 +2992,7 @@ static const struct efi_boot_services efi_boot_services = {
 	.hdr = {
 		.signature = EFI_BOOT_SERVICES_SIGNATURE,
 		.revision = EFI_SPECIFICATION_VERSION,
-		.headersize = sizeof(struct efi_table_hdr),
+		.headersize = sizeof(struct efi_boot_services),
 	},
 	.raise_tpl = efi_raise_tpl,
 	.restore_tpl = efi_restore_tpl,
@@ -3048,7 +3048,7 @@ struct efi_system_table __efi_runtime_data systab = {
 	.hdr = {
 		.signature = EFI_SYSTEM_TABLE_SIGNATURE,
 		.revision = EFI_SPECIFICATION_VERSION,
-		.headersize = sizeof(struct efi_table_hdr),
+		.headersize = sizeof(struct efi_system_table),
 	},
 	.fw_vendor = (long)firmware_vendor,
 	.con_in = (void *)&efi_con_in,
diff --git a/lib/efi_loader/efi_runtime.c b/lib/efi_loader/efi_runtime.c
index cfa60b8ff7..1acb06a206 100644
--- a/lib/efi_loader/efi_runtime.c
+++ b/lib/efi_loader/efi_runtime.c
@@ -460,7 +460,7 @@ struct efi_runtime_services __efi_runtime_data efi_runtime_services = {
 	.hdr = {
 		.signature = EFI_RUNTIME_SERVICES_SIGNATURE,
 		.revision = EFI_SPECIFICATION_VERSION,
-		.headersize = sizeof(struct efi_table_hdr),
+		.headersize = sizeof(struct efi_runtime_services),
 	},
 	.get_time = &efi_get_time_boottime,
 	.set_time = (void *)&efi_device_error,
-- 
2.18.0

