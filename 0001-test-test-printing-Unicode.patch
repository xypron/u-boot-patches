From 371243d14607037245ab6a3b9f403f187a5f6094 Mon Sep 17 00:00:00 2001
From: Heinrich Schuchardt <xypron.glpk@gmx.de>
Date: Thu, 19 Jul 2018 19:52:25 +0200
Subject: [PATCH 1/1] test: test printing Unicode

Test printing of Unicode strings

Signed-off-by: Heinrich Schuchardt <xypron.glpk@gmx.de>
---
 test/unicode_ut.c | 60 +++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 60 insertions(+)

diff --git a/test/unicode_ut.c b/test/unicode_ut.c
index 29316606c4..b54ea43132 100644
--- a/test/unicode_ut.c
+++ b/test/unicode_ut.c
@@ -34,6 +34,65 @@ static const char d3[] = {0xe6, 0xbd, 0x9c, 0xe6, 0xb0, 0xb4, 0xe8, 0x89,
 static const char d4[] = {0xf0, 0x90, 0x92, 0x8d, 0xf0, 0x90, 0x92, 0x96,
 			  0xf0, 0x90, 0x92, 0x87, 0x00};
 
+/* Illegal utf-16 strings */
+static const u16 i1[] = {0x69, 0x31, 0xdc87, 0x6c, 0x00}; 
+static const u16 i2[] = {0x69, 0x32, 0xd801, 0xd801, 0x6c, 0x00}; 
+static const u16 i3[] = {0x69, 0x33, 0xd801, 0x00}; 
+
+static int ut_string16(void)
+{
+#if defined(CONFIG_EFI_LOADER) && \
+	!defined(CONFIG_SPL_BUILD) && !defined(API_BUILD)
+	char buf[20];
+
+	/* Test length and precision */
+	memset(buf, 0xff, sizeof(buf));
+	sprintf(buf, "%8.6ls", c2);
+	if (buf[1] != ' ')
+		return -1;
+	if (strncmp(&buf[2], d2, 7))
+		return -1;
+	if (buf[9])
+		return -1;
+
+	memset(buf, 0xff, sizeof(buf));
+	sprintf(buf, "%8.6ls", c4);
+	if (buf[4] != ' ')
+		return -1;
+	if (strncmp(&buf[5], d4, 12))
+		return -1;
+	if (buf[17])
+		return -1;
+
+	memset(buf, 0xff, sizeof(buf));
+	sprintf(buf, "%-8.2ls", c4);
+	if (strncmp(buf, d4, 8))
+		return -1;
+	if (buf[8] != ' ')
+		return -1;
+	if (buf[14])
+		return -1;
+
+	/* Test handling of illegal utf-16 sequences */
+	memset(buf, 0xff, sizeof(buf));
+	sprintf(buf, "%ls", i1);
+	if (strcmp(buf, "i1?l"))
+		return -1;
+
+	memset(buf, 0xff, sizeof(buf));
+	sprintf(buf, "%ls", i2);
+	if (strcmp(buf, "i2?l"))
+		return -1;
+
+	memset(buf, 0xff, sizeof(buf));
+	sprintf(buf, "%ls", i3);
+	if (strcmp(buf, "i3?"))
+		return -1;
+
+#endif
+	return 0;
+}
+
 static int ut_utf8_get(void)
 {
 	const char *s;
@@ -451,6 +510,7 @@ int do_ut_unicode(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
 {
 	int ret = 0;
 
+	ret |= ut_string16();
 	ret |= ut_utf8_get();
 	ret |= ut_utf8_put();
 	ret |= ut_utf8_utf16_strlen();
-- 
2.18.0

