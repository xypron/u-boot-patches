From 382b4c0c090cb5702697babf593e5630c58e27e0 Mon Sep 17 00:00:00 2001
From: Heinrich Schuchardt <xypron.glpk@gmx.de>
Date: Fri, 9 Apr 2021 12:30:39 +0000
Subject: [PATCH 1/1] cmd/exception: support ebreak exception on RISC-V

The ebreak instruction should generate a breakpoint exception.

Signed-off-by: Heinrich Schuchardt <xypron.glpk@gmx.de>
---
 cmd/riscv/exception.c   | 10 ++++++++++
 doc/usage/exception.rst |  3 +++
 2 files changed, 13 insertions(+)

diff --git a/cmd/riscv/exception.c b/cmd/riscv/exception.c
index 9687cec812..7a08061d12 100644
--- a/cmd/riscv/exception.c
+++ b/cmd/riscv/exception.c
@@ -8,6 +8,13 @@
 #include <common.h>
 #include <command.h>
 
+static int do_ebreak(struct cmd_tbl *cmdtp, int flag, int argc,
+			char *const argv[])
+{
+	asm volatile ("ebreak\n");
+	return CMD_RET_FAILURE;
+}
+
 static int do_unaligned(struct cmd_tbl *cmdtp, int flag, int argc,
 			char *const argv[])
 {
@@ -28,6 +35,8 @@ static int do_undefined(struct cmd_tbl *cmdtp, int flag, int argc,
 }
 
 static struct cmd_tbl cmd_sub[] = {
+	U_BOOT_CMD_MKENT(ebreak, CONFIG_SYS_MAXARGS, 1, do_ebreak,
+			 "", ""),
 	U_BOOT_CMD_MKENT(unaligned, CONFIG_SYS_MAXARGS, 1, do_unaligned,
 			 "", ""),
 	U_BOOT_CMD_MKENT(undefined, CONFIG_SYS_MAXARGS, 1, do_undefined,
@@ -37,6 +46,7 @@ static struct cmd_tbl cmd_sub[] = {
 static char exception_help_text[] =
 	"<ex>\n"
 	"  The following exceptions are available:\n"
+	"  ebreak    - breakpoint\n"
 	"  undefined - illegal instruction\n"
 	"  unaligned - load address misaligned\n"
 	;
diff --git a/doc/usage/exception.rst b/doc/usage/exception.rst
index db1490f005..27df88bd5c 100644
--- a/doc/usage/exception.rst
+++ b/doc/usage/exception.rst
@@ -31,6 +31,9 @@ type
 
   **RISC-V:**
 
+  ebreak
+    breakpoint exception
+
   unaligned
     load address misaligned
 
-- 
2.31.0

